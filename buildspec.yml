version: 0.2
env:
  parameter-store:
    AWS_ACCESS_KEY_ID: /CodeBuild/AwsAccessKey
    AWS_SECRET_ACCESS_KEY: /CodeBuild/AwsSecretAccessKey
    AWS_DEFAULT_REGION: /CodeBuild/AwsDefaultRegion
  variables:
    ENV_NAME: Dev
phases:
  install:
    runtime-versions:
      nodejs: 8
    commands:
      - echo Installing Serverless...
      - npm install -g serverless
  pre_build:
    commands:
      - echo Installing frontend NPM dependencies...
      - cd frontend && npm install
      - echo installing backend dependencies
      - cd ../backend && npm install
  build:
    commands:
      - echo Deployment started on `date`
      - echo Deploying with Serverless Framework
      - sls deploy -v -s $ENV_NAME
      - echo frontend build started
      - cd ../frontend && npm run build
  post_build:
    commands:
      - echo deploy to s3
      - "aws s3 rb s3://cicd-demo-aws --force"
      - "aws s3 mb s3://cicd-demo-aws"
      - "aws s3 cp --recursive --acl public-read ./frontend/build s3://cicd-demo-aws"
      - echo Deployment completed on `date`
